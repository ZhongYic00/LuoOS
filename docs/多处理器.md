# SMP  
区域赛后我们为内核引入了SMP支持，并能通过区域赛测例及部分busybox测例。但在后续开发过程中，由于工期紧张、多线程引入的强不确定性不利于调测，SMP支持暂时已被关闭。  

SMP的实现主要为三部分：  
- 1. 硬件相关的支持。该部分我们对三方面进行了改造，  
    其一是从Linux引入了SBI的HSM、IPI功能子集，用于对remote核进行电源管理和remote fence；  
    其二是修复了此前PLIC部分的错误，实现了各个核对其外部中断的管理；  
    其三是内核运行环境的改造，首先规范了hartid的获取和保存（暂时保存于tp寄存器），其次基于hartid实现了各个核的局部变量的正确获取，和基于此的内核线程栈获取。  
- 2. 基于锁的访问控制。该部分我们实现了两个层面的支持，其一是仿照STL接口实现了自旋锁、条件变量等锁机制；其二是基于C++生命周期、指针折叠等特性，实现了`lock_guard`和`LockedPtr`等工具类型，其中`LockedObject`能够实现与原生指针相同的调用方式、访问时自动加解锁。  
    由于初期我们就通过`kHartObj`与`kGlobObj`区分了相应的对象，因此经过简单的replace我们就完成了加锁的改造。当然直接对对象加锁的粒度较大，性能欠佳，后续也容易依次将`LockedObject`封装层级内推。  
- 3. 多线程下的优化。该部分主要为对各模块增加线程局部缓存、和调度器对线程切换开销的优化，优先级低，目前尚未实现。  

目前，内核首先从任意一个hart上启动，启动核进行内存、外设、文件等子系统的初始化后，通过SBI HSM调用唤起其他核；其他核基于原子变量判断后只进行PLIC和CSR初始化；随后各核会测试自旋锁获取，最后创建KIdle内核线程并进行第一次调度。